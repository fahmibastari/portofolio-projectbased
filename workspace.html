<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="icon" href="image/profile/icon.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fahmi Bastari - Fullstack Developer</title>
<script src="https://unpkg.com/@phosphor-icons/web@2.1.1/src/index.js" defer></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --h:41px;--icon:40px;--lpanel:200px;--rpanel:240px;
  --ui:#2c2c2c;--base:#1e1e1e;--hover:#383838;--active:#404040;
  --bd:#3a3a3a;--tx:#e0e0e0;--dim:#8b8b8b;--muted:#555;
  --accent:#7c5cbf;
}
html,body{height:100%;overflow:hidden;font-family:'Inter',sans-serif;font-size:12px;background:var(--base);color:var(--tx);}

/* â”€â”€ LOADER â”€â”€ */
#loader{position:fixed;inset:0;background:#1e1e1e;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .4s;}
#loader.done{opacity:0;pointer-events:none;}
.l-thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;border:2px solid #3a3a3a;}
.l-name{font-size:13px;color:var(--dim);}
.l-sub{font-size:11px;color:var(--muted);}
.l-bar-wrap{width:220px;height:3px;background:#333;border-radius:2px;overflow:hidden;}
.l-bar{height:100%;width:0;background:var(--accent);border-radius:2px;transition:width .05s linear;}

/* â”€â”€ SHELL â”€â”€ */
.shell{display:grid;grid-template-rows:var(--h) 1fr;grid-template-columns:var(--icon) var(--lpanel) 1fr var(--rpanel);height:100vh;overflow:hidden;}

/* â”€â”€ TITLEBAR â”€â”€ */
.titlebar{grid-column:1/-1;background:var(--ui);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 10px;gap:8px;user-select:none;}
.t-logo{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:5px;cursor:pointer;text-decoration:none;color:inherit;}
.t-logo:hover{background:var(--hover);}
.t-logo img{width:20px;height:20px;border-radius:50%;object-fit:cover;}
.t-logo span{font-size:12px;font-weight:600;}
.t-sep{width:1px;height:18px;background:var(--bd);margin:0 4px;}
.t-bread{font-size:11px;color:var(--dim);display:flex;align-items:center;gap:5px;}
.t-space{flex:1;}
.t-tabs{display:flex;gap:1px;}
.t-tab{padding:5px 13px;border-radius:5px;font-size:11px;font-weight:500;color:var(--dim);cursor:pointer;transition:all .15s;}
.t-tab.on{background:var(--active);color:var(--tx);}
.t-zoom-btn{padding:4px 9px;background:transparent;border:none;font-family:inherit;font-size:11px;color:var(--dim);cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:3px;}
.t-zoom-btn:hover{background:var(--hover);color:var(--tx);}
.t-share{padding:5px 14px;background:var(--accent);color:#fff;font-size:11px;font-weight:600;border:none;border-radius:6px;cursor:pointer;font-family:inherit;display:flex;align-items:center;gap:4px;}
.t-share:hover{opacity:.88;}
.t-back{padding:5px 10px;background:transparent;border:1px solid var(--bd);color:var(--dim);font-size:11px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:4px;font-family:inherit;}
.t-back:hover{background:var(--hover);color:var(--tx);}

/* â”€â”€ ICON BAR â”€â”€ */
.iconbar{background:var(--ui);border-right:1px solid var(--bd);display:flex;flex-direction:column;align-items:center;padding:6px 0;gap:2px;}
.ib{width:32px;height:32px;border:none;background:transparent;border-radius:5px;color:var(--dim);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:inherit;}
.ib:hover{background:var(--hover);color:var(--tx);}
.ib.on{background:var(--accent);color:#fff;}
.ib-sep{width:22px;height:1px;background:var(--bd);margin:3px 0;}

/* â”€â”€ LEFT PANEL â”€â”€ */
.lpanel{background:var(--ui);border-right:1px solid var(--bd);display:flex;flex-direction:column;overflow:hidden;}
.lp-tabs{display:flex;border-bottom:1px solid var(--bd);flex-shrink:0;}
.lp-tab{flex:1;padding:6px 0;text-align:center;font-size:11px;font-weight:500;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;}
.lp-tab.on{color:var(--tx);border-bottom-color:var(--tx);}
.lp-body{flex:1;overflow-y:auto;padding:4px 0;scrollbar-width:thin;scrollbar-color:var(--bd) transparent;}
.lp-sec{padding:6px 10px 3px;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;display:flex;justify-content:space-between;align-items:center;}
.lp-sec button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:0;}
.lp-item{display:flex;align-items:center;gap:6px;padding:4px 8px;border-radius:4px;margin:1px 4px;cursor:pointer;color:var(--dim);font-size:11px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;transition:all .15s;}
.lp-item:hover{background:var(--hover);color:var(--tx);}
.lp-item.on{background:rgba(124,92,191,.2);color:#c4a8ff;}

/* â”€â”€ CANVAS â”€â”€ */
.canvas-wrap{overflow:hidden;background:#f0f0f0;background-image:radial-gradient(circle,#c0c0c0 1px,transparent 1px);background-size:20px 20px;position:relative;cursor:default;}
.canvas-world{position:absolute;top:0;left:0;width:3000px;height:2400px;transform-origin:0 0;}

/* â”€â”€ ARTBOARD FRAMES â”€â”€ */
.cframe{position:absolute;background:#fff;box-shadow:0 2px 20px rgba(0,0,0,.15);cursor:default;}
.cframe.sel{outline:2px solid #7c5cbf;}
.cframe.sel>.frame-lbl{color:#7c5cbf;}
.frame-lbl{position:absolute;top:-20px;left:0;font-size:11px;font-weight:500;color:#666;white-space:nowrap;pointer-events:none;font-family:'Inter',sans-serif;}

/* Frame content styles */
.cover-wrap{position:relative;width:100%;height:100%;overflow:hidden;background:#0d1117;}
.cover-wrap img{width:100%;height:100%;object-fit:cover;opacity:.7;}
.cover-ov{position:absolute;inset:0;background:linear-gradient(135deg,rgba(13,17,23,.9) 30%,transparent);display:flex;flex-direction:column;justify-content:flex-end;padding:22px;}
.ctag{font-size:9px;font-weight:700;color:#4a9ca6;text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px;}
.ctitle{font-size:20px;font-weight:800;color:#fff;line-height:1.1;margin-bottom:5px;}
.csub{font-size:10px;color:rgba(255,255,255,.5);}

.about-pad{padding:22px;display:flex;flex-direction:column;gap:10px;}
.a-label{font-size:9px;font-weight:700;color:#4a9ca6;text-transform:uppercase;letter-spacing:.1em;}
.a-title{font-size:13px;font-weight:700;color:#111;line-height:1.35;}
.a-body{font-size:10.5px;color:#555;line-height:1.7;flex:1;}
.a-hr{height:1px;background:#eee;}
.a-meta{display:flex;gap:18px;}
.a-mi label{font-size:8px;color:#aaa;text-transform:uppercase;display:block;margin-bottom:2px;}
.a-mi span{font-size:10px;font-weight:600;color:#222;}

.tech-pad{padding:18px;}
.tech-title{font-size:9px;font-weight:700;color:#aaa;text-transform:uppercase;margin-bottom:10px;}
.tech-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.tech-chip{display:flex;align-items:center;gap:6px;padding:7px 9px;background:#f7f7f7;border:1px solid #eee;border-radius:5px;font-size:10.5px;font-weight:500;color:#333;}
.tech-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}

.sc-grid{display:grid;gap:8px;padding:16px;align-content:start;}
.sc-card{border-radius:5px;overflow:hidden;border:1px solid #e5e5e5;background:#f8f8f8;}
.sc-card img{width:100%;height:88px;object-fit:cover;object-position:top;display:block;}
.sc-label{font-size:9px;color:#777;font-weight:500;padding:4px 6px;}

/* Canvas user-drawn elements */
.canvas-elem{position:absolute;cursor:move;user-select:none;}
.canvas-elem.sel{outline:2px solid #7c5cbf;}
.shape-rect{background:rgba(124,92,191,.18);border:2px solid #7c5cbf;}
.shape-ellipse{background:rgba(74,156,166,.18);border:2px solid #4a9ca6;border-radius:50%;}
.text-elem{font-family:'Inter';font-size:16px;color:#111;background:transparent;outline:none;white-space:nowrap;min-width:80px;padding:2px 4px;}

/* Zoom HUD */
.zoom-ctrl{position:absolute;bottom:16px;right:12px;display:flex;align-items:center;gap:4px;background:var(--ui);border:1px solid var(--bd);border-radius:6px;padding:3px 6px;z-index:50;box-shadow:0 2px 8px rgba(0,0,0,.3);}
.zb{width:24px;height:24px;border:none;background:transparent;color:var(--dim);cursor:pointer;border-radius:4px;font-family:inherit;font-size:14px;display:flex;align-items:center;justify-content:center;}
.zb:hover{background:var(--hover);color:var(--tx);}
#zoomLabel{font-size:10px;color:var(--dim);min-width:36px;text-align:center;}

/* â”€â”€ RIGHT PANEL â”€â”€ */
.rpanel{background:var(--ui);border-left:1px solid var(--bd);display:flex;flex-direction:column;width:var(--rpanel);flex-shrink:0;overflow:hidden;}
.rp-tabs{display:flex;border-bottom:1px solid var(--bd);flex-shrink:0;}
.rp-tab{flex:1;padding:6px 0;text-align:center;font-size:11px;font-weight:500;color:var(--dim);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;}
.rp-tab.on{color:var(--tx);border-bottom-color:var(--tx);}
.rp-sel-row{padding:6px 10px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:6px;flex-shrink:0;}
.rp-sel-icon{width:14px;height:14px;background:var(--accent);border-radius:3px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.rp-sel-name{font-size:11px;font-weight:500;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rp-body{flex:1;overflow-y:auto;padding:10px;scrollbar-width:thin;scrollbar-color:var(--bd) transparent;}
.rp-sec{margin-bottom:12px;}
.rp-sec-title{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:7px;display:flex;justify-content:space-between;align-items:center;}
.rp-row2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;}
.rp-field label{font-size:9px;color:var(--muted);display:block;margin-bottom:2px;}
.rp-input{width:100%;background:var(--base);border:1px solid var(--bd);border-radius:4px;color:var(--tx);font-size:11px;font-family:inherit;padding:4px 7px;outline:none;}
.rp-input:focus{border-color:var(--accent);}
.rp-hr{height:1px;background:var(--bd);margin:8px 0;}
.rp-actions{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px;}
.align-btn{width:24px;height:24px;border:none;background:transparent;border-radius:4px;color:var(--dim);cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;}
.align-btn:hover{background:var(--hover);color:var(--tx);}
.fill-swatch{display:flex;align-items:center;gap:6px;padding:5px 7px;background:var(--base);border:1px solid var(--bd);border-radius:4px;cursor:pointer;}
.fill-dot{width:14px;height:14px;border-radius:3px;flex-shrink:0;}
.fill-hex{font-size:10px;color:var(--dim);}
.fill-op{margin-left:auto;font-size:10px;color:var(--muted);}
.font-select{width:100%;background:var(--base);border:1px solid var(--bd);border-radius:4px;color:var(--tx);font-size:11px;font-family:inherit;padding:5px 7px;margin-bottom:6px;cursor:pointer;outline:none;}
.rp-empty{padding:20px 10px;text-align:center;color:var(--muted);font-size:11px;line-height:1.6;}

/* â”€â”€ BOTTOM TOOLBAR â”€â”€ */
.btoolbar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);margin-left:calc((var(--icon) + var(--lpanel) - var(--rpanel)) / 2);display:flex;align-items:center;gap:3px;background:var(--ui);border:1px solid var(--bd);border-radius:10px;padding:4px;box-shadow:0 6px 24px rgba(0,0,0,.4);z-index:200;}
.bt{width:32px;height:32px;border:none;background:transparent;border-radius:7px;color:var(--dim);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:inherit;}
.bt:hover{background:var(--hover);color:var(--tx);}
.bt.on{background:var(--accent);color:#fff;}
.bt-sep{width:1px;height:20px;background:var(--bd);margin:0 2px;}

/* -- RESIZE HANDLES -- */
/* external handle overlay */
#hov .rh { position:absolute; pointer-events:all; }
#hov .sel-border { position:absolute; outline:2px solid #7c5cbf; pointer-events:none; }

.rh{position:absolute;width:8px;height:8px;background:#fff;border:1.5px solid #7c5cbf;border-radius:2px;z-index:500;box-sizing:border-box;}
.rh:hover{background:#7c5cbf;}
.rh[data-h="nw"]{top:-4px;left:-4px;cursor:nw-resize;}
.rh[data-h="n"] {top:-4px;left:calc(50% - 4px);cursor:n-resize;}
.rh[data-h="ne"]{top:-4px;right:-4px;cursor:ne-resize;}
.rh[data-h="e"] {top:calc(50% - 4px);right:-4px;cursor:e-resize;}
.rh[data-h="se"]{bottom:-4px;right:-4px;cursor:se-resize;}
.rh[data-h="s"] {bottom:-4px;left:calc(50% - 4px);cursor:s-resize;}
.rh[data-h="sw"]{bottom:-4px;left:-4px;cursor:sw-resize;}
.rh[data-h="w"] {top:calc(50% - 4px);left:-4px;cursor:w-resize;}

/* =============================================
   RESPONSIVE WORKSPACE
   ============================================= */

/* TABLET (<=1024px): hide lpanel, keep canvas + rpanel */
@media (max-width: 1024px) {
  :root { --lpanel: 0px; }
  .lpanel { display: none; }
  .shell { grid-template-columns: var(--icon) 0 1fr var(--rpanel); }
  #ibLayers { pointer-events: none; opacity: .4; }
  .btoolbar { margin-left: calc((var(--icon) - var(--rpanel)) / 2); }
}

/* MOBILE (<=768px): canvas only, rpanel becomes bottom drawer trigger */
@media (max-width: 768px) {
  :root { --rpanel: 0px; --icon: 0px; }
  .shell { grid-template-columns: 0 0 1fr 0; }
  .iconbar { display: none; }
  .lpanel  { display: none; }
  .rpanel  { display: none; }
  .btoolbar { left: 50%; margin-left: 0; transform: translateX(-50%); }
  .titlebar { padding: 0 8px; gap: 6px; }
  .t-back span { display: none; }
  .t-share span { display: none; }
  .t-bread { font-size: 10px; }
  .zoom-ctrl { bottom: 70px; }
}

/* SMALL MOBILE (<=480px): even more compact titlebar */
@media (max-width: 480px) {
  .t-tabs { display: none; }
  .t-zoom-btn { display: none; }
}

/* -- RESIZE HANDLES -- */
/* external handle overlay */
#hov .rh { position:absolute; pointer-events:all; }
#hov .sel-border { position:absolute; outline:2px solid #7c5cbf; pointer-events:none; }

.rh{position:absolute;width:8px;height:8px;background:#fff;border:1.5px solid #7c5cbf;border-radius:2px;z-index:500;box-sizing:border-box;pointer-events:all;}
.rh:hover{background:#c4a8ff;}
.rh[data-h="nw"]{top:-4px;left:-4px;cursor:nw-resize;}
.rh[data-h="n"]{top:-4px;left:calc(50% - 4px);cursor:n-resize;}
.rh[data-h="ne"]{top:-4px;right:-4px;cursor:ne-resize;}
.rh[data-h="e"]{top:calc(50% - 4px);right:-4px;cursor:e-resize;}
.rh[data-h="se"]{bottom:-4px;right:-4px;cursor:se-resize;}
.rh[data-h="s"]{bottom:-4px;left:calc(50% - 4px);cursor:s-resize;}
.rh[data-h="sw"]{bottom:-4px;left:-4px;cursor:sw-resize;}
.rh[data-h="w"]{top:calc(50% - 4px);left:-4px;cursor:w-resize;}
</style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <img class="l-thumb" id="loaderThumb" src="" alt="">
  <div style="text-align:center">
    <div class="l-name" id="loaderName">Loading project...</div>
    <div class="l-sub" id="loaderSub">Opening canvas...</div>
  </div>
  <div class="l-bar-wrap"><div class="l-bar" id="loaderBar"></div></div>
</div>

<div class="shell">
<!-- TITLEBAR -->
<header class="titlebar">
  <a class="t-logo" href="desktop.html">
    <img src="image/profile/profile.jpg" alt="">
    <span>Fahmi Bastari</span>
  </a>
  <div class="t-sep"></div>
  <div class="t-bread">
    <span style="color:var(--dim)">Portfolio</span>
    <span style="color:var(--muted)">/</span>
    <span id="breadName">â€”</span>
    <i class="ph ph-caret-down" style="font-size:10px;color:var(--muted);"></i>
  </div>
  <div class="t-space"></div>
  <div class="t-tabs">
    <div class="t-tab on">Design</div>
    <div class="t-tab">Prototype</div>
  </div>
  <div class="t-sep"></div>
  <button class="t-zoom-btn">
    <i class="ph ph-magnifying-glass" style="font-size:11px;"></i>
    <span id="zoomPct">100%</span>
    <i class="ph ph-caret-down" style="font-size:10px;"></i>
  </button>
  <button class="t-back" onclick="window.location='desktop.html'">
    <i class="ph ph-arrow-left" style="font-size:12px;"></i> Portfolio
  </button>
  <button class="t-share" onclick="window.location='desktop.html'">
    <i class="ph ph-arrow-up-right" style="font-size:12px;"></i> Contact
  </button>
</header>

<!-- ICON BAR -->
<div class="iconbar">
  <button class="ib on" id="ibLayers" onclick="togglePanel()" title="Layers">
    <i class="ph ph-stack" style="font-size:17px;"></i>
  </button>
  <button class="ib" title="Assets"><i class="ph ph-dots-nine" style="font-size:17px;"></i></button>
  <div class="ib-sep"></div>
  <button class="ib" title="Search"><i class="ph ph-magnifying-glass" style="font-size:17px;"></i></button>
</div>

<!-- LEFT PANEL -->
<div class="lpanel" id="lpanel">
  <div class="lp-tabs">
    <div class="lp-tab on">Layers</div>
    <div class="lp-tab">Assets</div>
  </div>
  <div class="lp-body">
    <div class="lp-sec">Pages <button><i class="ph ph-plus"></i></button></div>
    <div class="lp-item on"><i class="ph ph-file" style="opacity:.6;font-size:11px;"></i> <span id="pageLabel">Project</span></div>
    <div class="lp-sec" style="margin-top:8px;">Layers</div>
    <div id="layersList"></div>
  </div>
</div>

<!-- CANVAS -->
<div class="canvas-wrap" id="canvasWrap">
  <div class="canvas-world" id="world"><div id="hov" style="position:absolute;top:0;left:0;pointer-events:none;z-index:9000;"></div></div>
  <div class="zoom-ctrl">
    <button class="zb" onclick="changeZoom(-0.1)">âˆ’</button>
    <span id="zoomLabel">100%</span>
    <button class="zb" onclick="changeZoom(0.1)">+</button>
    <button class="zb" onclick="fitToScreen()" style="font-size:10px;width:auto;padding:0 6px;">Fit</button>
  </div>
</div>

<!-- RIGHT PANEL -->
<div class="rpanel">
  <div class="rp-tabs">
    <div class="rp-tab on">Design</div>
    <div class="rp-tab">Prototype</div>
    <div class="rp-tab">Inspect</div>
  </div>
  <div class="rp-sel-row">
    <div class="rp-sel-icon"><i class="ph ph-frame-corners" style="font-size:9px;color:#fff;"></i></div>
    <div class="rp-sel-name" id="rpSelName">Nothing selected</div>
  </div>
  <div class="rp-body" id="rpBody">
    <div class="rp-empty">Click a frame or element on the canvas to inspect its properties.</div>
  </div>
</div>
</div><!-- /shell -->

<!-- BOTTOM TOOLBAR -->
<div class="btoolbar">
  <button class="bt on" data-tool="select" title="Move (V)"><i class="ph-fill ph-cursor" style="font-size:15px;"></i></button>
  <button class="bt" data-tool="frame"  title="Frame (F)"><i class="ph ph-frame-corners" style="font-size:15px;"></i></button>
  <div class="bt-sep"></div>
  <button class="bt" data-tool="rect"   title="Rectangle (R)"><i class="ph ph-square" style="font-size:15px;"></i></button>
  <button class="bt" data-tool="ellipse"title="Ellipse (O)"><i class="ph ph-circle" style="font-size:15px;"></i></button>
  <div class="bt-sep"></div>
  <button class="bt" data-tool="text"   title="Text (T)"><i class="ph ph-text-t" style="font-size:15px;"></i></button>
  <div class="bt-sep"></div>
  <button class="bt" data-tool="hand"   title="Hand (H)"><i class="ph ph-hand" style="font-size:15px;"></i></button>
  <div class="bt-sep"></div>
  <button class="bt" title="Comment"><i class="ph ph-chat-circle" style="font-size:15px;"></i></button>
</div>

<!-- DATA + LOGIC -->
<script src="projects.js"></script>
<script>
/* â”€â”€ STATE â”€â”€ */
let zoom=1, panX=60, panY=60;
let tool='select';
let selectedEl=null;
let isPanning=false, panStart={x:0,y:0};
let isDragging=false, dragStart={x:0,y:0}, dragElStart={x:0,y:0};
let isDrawing=false, drawStart={x:0,y:0}, drawEl=null;

const world   = document.getElementById('world');
const cWrap   = document.getElementById('canvasWrap');
const PROJECT = getProjectFromURL();

/* â”€â”€ LOADER â”€â”€ */
const loader    = document.getElementById('loader');
const loaderBar = document.getElementById('loaderBar');
const steps     = ['Loading project assets...','Building canvas layers...','Rendering frames...','Finalizing...'];
let pct=0;

if(!PROJECT){
  document.getElementById('loaderName').textContent='Project not found';
  document.getElementById('loaderSub').textContent='Redirecting...';
  setTimeout(()=>window.location='desktop.html', 1500);
} else {
  document.title = PROJECT.name + ' â€” Portfolio Canvas';
  document.getElementById('loaderThumb').src  = PROJECT.thumb;
  document.getElementById('loaderName').textContent = PROJECT.name;
  function tick(){
    pct += Math.random()*8+4;
    if(pct>100) pct=100;
    loaderBar.style.width = pct+'%';
    document.getElementById('loaderSub').textContent = steps[Math.min(Math.floor(pct/25),3)];
    if(pct<100){ setTimeout(tick,80); }
    else{ setTimeout(()=>{ loader.classList.add('done'); setTimeout(()=>loader.remove(),420); boot(); },200); }
  }
  window.addEventListener('DOMContentLoaded', ()=>setTimeout(tick,300));
}

/* â”€â”€ TRANSFORM â”€â”€ */
function applyTransform(){
  world.style.transform=`translate(${panX}px,${panY}px) scale(${zoom})`;
  world.style.transformOrigin='0 0';
  const pcts=Math.round(zoom*100)+'%';
  document.getElementById('zoomLabel').textContent=pcts;
  document.getElementById('zoomPct').textContent=pcts;
}
function changeZoom(delta,ox,oy){
  const w=cWrap.getBoundingClientRect();
  const cx=ox??w.width/2, cy=oy??w.height/2;
  const prev=zoom;
  zoom=Math.min(8,Math.max(0.1,zoom+delta));
  panX=cx-(cx-panX)*(zoom/prev);
  panY=cy-(cy-panY)*(zoom/prev);
  applyTransform();
}
function fitToScreen(){
  zoom=Math.min(cWrap.clientWidth/2400,cWrap.clientHeight/1800)*0.85;
  panX=(cWrap.clientWidth-2400*zoom)/2;
  panY=(cWrap.clientHeight-1800*zoom)/2;
  applyTransform();
}
cWrap.addEventListener('wheel',e=>{
  e.preventDefault();
  const r=cWrap.getBoundingClientRect();
  changeZoom(e.deltaY<0?0.08:-0.08,e.clientX-r.left,e.clientY-r.top);
},{passive:false});

/* â”€â”€ BOOT: build canvas from PROJECT data â”€â”€ */
function boot(){
  // Update breadcrumb + page label
  document.getElementById('breadName').textContent=PROJECT.name;
  document.getElementById('pageLabel').textContent=PROJECT.name;

  const imgs=PROJECT.images;
  /* Layout strategy:
     Row 0 (y=50):  Cover(360Ã—240)  About(320Ã—240)  Tech(280Ã—240)
     Row 1 (y=330): Screenshots block â€” all remaining images in responsive grid
  */
  addFrame({x:50,y:50,w:360,h:240},'Thumbnail',buildCover());
  addFrame({x:450,y:50,w:320,h:240},'About this project',buildAbout());
  addFrame({x:810,y:50,w:280,h:240},'Tech Stack',buildTech());

  // Dynamic screenshot frames: split images into groups of 4
  const COLS=4;
  let col=0, row=0, startX=50, startY=330;
  const frameW=660, imgH=88;
  const rowImgs=[];
  let chunk=[];
  imgs.forEach((im,i)=>{
    chunk.push(im);
    if(chunk.length===COLS||(i===imgs.length-1&&chunk.length>0)){
      rowImgs.push([...chunk]);
      chunk=[];
    }
  });
  rowImgs.forEach((group,ri)=>{
    const fW=group.length>=4?680:group.length*166;
    const fH=imgH+36+24;
    addFrame({x:startX+(ri%2)*(700),y:startY+Math.floor(ri/2)*(fH+20),w:fW,h:fH},
      `Screenshots ${ri>0?'('+(ri+1)+')':''}`,buildScreens(group,group.length));
  });

  buildLayersList();
  applyTransform();
  const first=world.querySelector('.cframe');
  if(first) selectEl(first);
}

/* â”€â”€ FRAME BUILDERS â”€â”€ */
function buildCover(){
  const d=document.createElement('div');
  d.className='cover-wrap';
  d.innerHTML=`<img src="${PROJECT.thumb}" alt="">
    <div class="cover-ov">
      <div class="ctag">${PROJECT.category}</div>
      <div class="ctitle">${PROJECT.name}</div>
      <div class="csub">${PROJECT.desc.slice(0,70)}...</div>
    </div>`;
  return d;
}
function buildAbout(){
  const d=document.createElement('div');
  d.className='about-pad';
  d.style.height='100%';
  d.innerHTML=`
    <div class="a-label">About this project</div>
    <div class="a-title">${PROJECT.name}</div>
    <div class="a-body">${PROJECT.desc}</div>
    <div class="a-hr"></div>
    <div class="a-meta">
      <div class="a-mi"><label>Timeline</label><span>${PROJECT.timeline}</span></div>
      <div class="a-mi"><label>Role</label><span>${PROJECT.role}</span></div>
      <div class="a-mi"><label>Type</label><span>${PROJECT.type}</span></div>
    </div>`;
  return d;
}
function buildTech(){
  const d=document.createElement('div');
  d.className='tech-pad';
  const chips=PROJECT.tech.map(t=>`<div class="tech-chip"><div class="tech-dot" style="background:${t.color};"></div>${t.name}</div>`).join('');
  d.innerHTML=`<div class="tech-title">Tech Stack</div><div class="tech-grid">${chips}</div>`;
  return d;
}
function buildScreens(imgs, cols=4){
  const d=document.createElement('div');
  d.className='sc-grid';
  d.style.gridTemplateColumns=`repeat(${Math.min(cols,imgs.length)},1fr)`;
  d.innerHTML=imgs.map(im=>`<div class="sc-card"><img src="${im.file}" alt="${im.label}"><div class="sc-label">${im.label}</div></div>`).join('');
  return d;
}

/* â”€â”€ ADD FRAME â”€â”€ */
function addFrame(pos,label,inner){
  const el=document.createElement('div');
  el.className='cframe';
  el.dataset.label=label; el.dataset.kind='frame';
  el.dataset.x=pos.x; el.dataset.y=pos.y; el.dataset.w=pos.w; el.dataset.h=pos.h;
  el.style.cssText=`left:${pos.x}px;top:${pos.y}px;width:${pos.w}px;height:${pos.h}px;overflow:hidden;`;
  const lbl=document.createElement('div'); lbl.className='frame-lbl'; lbl.textContent=label;
  el.appendChild(lbl); el.appendChild(inner);
  el.addEventListener('mousedown',e=>{ if(tool==='select') startDrag(e,el); });
  el.addEventListener('click',e=>{ e.stopPropagation(); selectEl(el); });
  world.appendChild(el);
}

/* â”€â”€ LAYERS â”€â”€ */
function buildLayersList(){
  const list=document.getElementById('layersList');
  list.innerHTML='';
  world.querySelectorAll('.cframe,.canvas-elem').forEach(el=>{
    const item=document.createElement('div');
    item.className='lp-item';
    const isFrame=el.classList.contains('cframe');
    item.innerHTML=`<i class="ph ${isFrame?'ph-frame-corners':'ph-square'}" style="font-size:11px;opacity:.6;"></i> ${el.dataset.label||el.dataset.kind||'Element'}`;
    item.addEventListener('click',()=>selectEl(el));
    el._li=item;
    list.appendChild(item);
  });
}

/* â”€â”€ SELECT / DESELECT â”€â”€ */
/*  EXTERNAL HANDLE OVERLAY  */
function clearHandles(){
  const hov=document.getElementById('hov');
  if(hov) hov.innerHTML='';
}
function setHandlesPos(el){
  const hov=document.getElementById('hov'); if(!hov) return;
  hov.innerHTML='';
  if(el.classList.contains('text-elem')) return; // text auto-sizes, no handles
  const l=parseFloat(el.style.left)||0,  t=parseFloat(el.style.top)||0;
  const w=parseFloat(el.style.width)||el.offsetWidth||80;
  const h=parseFloat(el.style.height)||el.offsetHeight||24;
  // selection border
  const brd=document.createElement('div'); brd.className='sel-border';
  brd.style.cssText=`left:${l}px;top:${t}px;width:${w}px;height:${h}px;`;
  hov.appendChild(brd);
  // 8 handles
  const pts={ nw:[l-4,t-4], n:[l+w/2-4,t-4], ne:[l+w-4,t-4],
               e:[l+w-4,t+h/2-4], se:[l+w-4,t+h-4], s:[l+w/2-4,t+h-4],
               sw:[l-4,t+h-4], w:[l-4,t+h/2-4] };
  const cursors={ nw:'nw-resize',n:'n-resize',ne:'ne-resize',e:'e-resize',
                  se:'se-resize',s:'s-resize',sw:'sw-resize',w:'w-resize' };
  Object.entries(pts).forEach(([pos,[x,y]])=>{
    const hdl=document.createElement('div');
    hdl.className='rh'; hdl.dataset.h=pos;
    hdl.style.cssText=`left:${x}px;top:${y}px;cursor:${cursors[pos]};`;
    hdl.addEventListener('mousedown',ev=>{ ev.stopPropagation(); startResize(ev,el,pos); });
    hov.appendChild(hdl);
  });
}
function selectEl(el){
  if(selectedEl){ selectedEl.classList.remove('sel'); if(selectedEl._li) selectedEl._li.classList.remove('on'); }
  clearHandles();
  selectedEl=el;
  el.classList.add('sel');
  if(el._li) el._li.classList.add('on');
  setHandlesPos(el);
  renderRightPanel(el);
}
function deselect(){
  if(selectedEl){ selectedEl.classList.remove('sel'); if(selectedEl._li) selectedEl._li.classList.remove('on'); selectedEl=null; }
  clearHandles();
  document.getElementById('rpSelName').textContent='Nothing selected';
  document.getElementById('rpBody').innerHTML='<div class="rp-empty">Click a frame or element to inspect.</div>';
}
function startResize(e,el,pos){
  e.stopPropagation(); e.preventDefault();
  const sx=e.clientX,sy=e.clientY;
  const sl=parseFloat(el.style.left)||0,st=parseFloat(el.style.top)||0;
  const sw=parseFloat(el.style.width)||100,sh=parseFloat(el.style.height)||100;
  const move=ev=>{
    const dx=(ev.clientX-sx)/zoom, dy=(ev.clientY-sy)/zoom;
    let l=sl,t=st,w=sw,h=sh;
    if(pos.includes('w')){ l=sl+dx; w=Math.max(20,sw-dx); }
    if(pos.includes('e')){ w=Math.max(20,sw+dx); }
    if(pos.includes('n')){ t=st+dy; h=Math.max(20,sh-dy); }
    if(pos.includes('s')){ h=Math.max(20,sh+dy); }
    el.style.left=l+'px'; el.style.top=t+'px';
    el.style.width=w+'px'; el.style.height=h+'px';
    el.dataset.w=Math.round(w); el.dataset.h=Math.round(h);
    const ix=document.getElementById('inpX'),iy=document.getElementById('inpY');
    const iw=document.getElementById('inpW'),ih_=document.getElementById('inpH');
    if(ix) ix.value=Math.round(l); if(iy) iy.value=Math.round(t);
    if(iw) iw.value=Math.round(w); if(ih_) ih_.value=Math.round(h);
    setHandlesPos(el);
  };
  const up=()=>{ document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); };
  document.addEventListener('mousemove',move); document.addEventListener('mouseup',up);
}

/* â”€â”€ RIGHT PANEL â”€â”€ */
function renderRightPanel(el){
  const name=el.dataset.label||el.dataset.kind||'Element';
  document.getElementById('rpSelName').textContent=name;
  const x=Math.round(parseFloat(el.style.left)||parseFloat(el.dataset.x)||0);
  const y=Math.round(parseFloat(el.style.top)||parseFloat(el.dataset.y)||0);
  const w=Math.round(parseFloat(el.style.width)||parseFloat(el.dataset.w)||100);
  const h=Math.round(parseFloat(el.style.height)||parseFloat(el.dataset.h)||100);
  const rot=el.dataset.rotation||'0';
  const opa=el.style.opacity?Math.round(parseFloat(el.style.opacity)*100):100;
  const rawBg=el.style.backgroundColor||el.style.background||'#ffffff';
  const hexBg=rawBg.startsWith('#')?rawBg:rgbToHex(rawBg);
  const ff=(el.style.fontFamily||'Inter').replace(/["']/g,'').split(',')[0].trim();
  const fs=el.style.fontSize?parseInt(el.style.fontSize):16;
  const lh=el.style.lineHeight||'Auto';
  const tc=el.style.color||'#111111';
  const fonts=['Inter','Manrope','Roboto','Georgia','Courier New'];
  const fontOpts=fonts.map(f=>`<option${f===ff?' selected':''}>${f}</option>`).join('');
  document.getElementById('rpBody').innerHTML=`
    <div class="rp-sec">
      <div class="rp-sec-title">Alignment</div>
      <div class="rp-actions">
        <button class="align-btn" onclick="alignEl('left')" title="Left"><i class="ph ph-align-left" style="font-size:13px;"></i></button>
        <button class="align-btn" onclick="alignEl('cx')" title="Center H"><i class="ph ph-align-center-horizontal" style="font-size:13px;"></i></button>
        <button class="align-btn" onclick="alignEl('right')" title="Right"><i class="ph ph-align-right" style="font-size:13px;"></i></button>
        <button class="align-btn" onclick="alignEl('top')" title="Top"><i class="ph ph-align-top" style="font-size:13px;"></i></button>
        <button class="align-btn" onclick="alignEl('cy')" title="Center V"><i class="ph ph-align-center-vertical" style="font-size:13px;"></i></button>
        <button class="align-btn" onclick="alignEl('bottom')" title="Bottom"><i class="ph ph-align-bottom" style="font-size:13px;"></i></button>
      </div>
    </div>
    <div class="rp-hr"></div>
    <div class="rp-sec">
      <div class="rp-sec-title">Position</div>
      <div class="rp-row2">
        <div class="rp-field"><label>X</label><input class="rp-input" id="inpX" type="number" value="${x}" oninput="moveEl('x',this.value)"></div>
        <div class="rp-field"><label>Y</label><input class="rp-input" id="inpY" type="number" value="${y}" oninput="moveEl('y',this.value)"></div>
      </div>
      <div class="rp-row2">
        <div class="rp-field"><label>W</label><input class="rp-input" id="inpW" type="number" value="${w}" oninput="resizeEl('w',this.value)"></div>
        <div class="rp-field"><label>H</label><input class="rp-input" id="inpH" type="number" value="${h}" oninput="resizeEl('h',this.value)"></div>
      </div>
      <div class="rp-row2">
        <div class="rp-field"><label>Rotation</label><input class="rp-input" id="inpRot" type="number" value="${rot}" oninput="rotateEl(this.value)"></div>
        <div class="rp-field"><label>Opacity %</label><input class="rp-input" id="inpOpa" type="number" min="0" max="100" value="${opa}" oninput="setOpacity(this.value)"></div>
      </div>
    </div>
    <div class="rp-hr"></div>
    <div class="rp-sec">
      <div class="rp-sec-title">Fill</div>
      <div class="fill-swatch" onclick="pickColor()">
        <div class="fill-dot" id="fillDot" style="background:${hexBg};"></div>
        <span class="fill-hex" id="fillHex">${hexBg.replace('#','').toUpperCase()}</span>
        <span class="fill-op">${opa}%</span>
      </div>
    </div>
    <div class="rp-hr"></div>
    <div class="rp-sec">
      <div class="rp-sec-title">Typography</div>
      <select class="font-select" id="inpFont" onchange="setFont(this.value)">${fontOpts}</select>
      <div class="rp-row2">
        <div class="rp-field"><label>Size</label><input class="rp-input" id="inpFsize" type="number" value="${fs}" oninput="setFontSize(this.value)"></div>
        <div class="rp-field"><label>Line H</label><input class="rp-input" id="inpLh" value="${lh}" oninput="setLineH(this.value)"></div>
      </div>
      <div class="rp-sec-title" style="margin-top:6px;">Text Color</div>
      <div class="fill-swatch" onclick="pickTextColor()">
        <div class="fill-dot" id="tcDot" style="background:${tc};"></div>
        <span class="fill-hex" id="tcHex">${tc.replace('#','').slice(0,6).toUpperCase()||'111111'}</span>
      </div>
    </div>`;
}
function rgbToHex(rgb){
  if(!rgb||rgb==='transparent') return '#ffffff';
  const m=rgb.match(/\d+/g); if(!m) return '#ffffff';
  return '#'+m.slice(0,3).map(n=>parseInt(n).toString(16).padStart(2,'0')).join('');
}
function moveEl(axis,val){
  if(!selectedEl) return;
  val=parseInt(val)||0;
  if(axis==='x') selectedEl.style.left=val+'px'; else selectedEl.style.top=val+'px';
}
function resizeEl(axis,val){
  if(!selectedEl) return;
  val=Math.max(4,parseInt(val)||4);
  if(axis==='w'){ selectedEl.style.width=val+'px'; selectedEl.dataset.w=val; }
  else           { selectedEl.style.height=val+'px'; selectedEl.dataset.h=val; }
}
function rotateEl(val){
  if(!selectedEl) return;
  const deg=parseFloat(val)||0;
  selectedEl.dataset.rotation=deg;
  selectedEl.style.transform=`rotate(${deg}deg)`;
}
function setOpacity(val){
  if(!selectedEl) return;
  val=Math.min(100,Math.max(0,parseInt(val)||100));
  selectedEl.style.opacity=val/100;
}
function alignEl(dir){
  if(!selectedEl) return;
  const wW=cWrap.clientWidth/zoom, wH=cWrap.clientHeight/zoom;
  const eW=parseFloat(selectedEl.style.width)||80;
  const eH=parseFloat(selectedEl.style.height)||24;
  if(dir==='left')   selectedEl.style.left='0px';
  if(dir==='cx')     selectedEl.style.left=(wW/2-eW/2)+'px';
  if(dir==='right')  selectedEl.style.left=(wW-eW)+'px';
  if(dir==='top')    selectedEl.style.top='0px';
  if(dir==='cy')     selectedEl.style.top=(wH/2-eH/2)+'px';
  if(dir==='bottom') selectedEl.style.top=(wH-eH)+'px';
  const ix=document.getElementById('inpX'),iy=document.getElementById('inpY');
  if(ix) ix.value=Math.round(parseFloat(selectedEl.style.left)||0);
  if(iy) iy.value=Math.round(parseFloat(selectedEl.style.top)||0);
}
function setFont(val){ if(selectedEl) selectedEl.style.fontFamily=val; }
function setFontSize(val){ if(!selectedEl) return; val=Math.max(6,parseInt(val)||6); selectedEl.style.fontSize=val+'px'; }
function setLineH(val){ if(selectedEl) selectedEl.style.lineHeight=val; }
function openColorPicker(initVal, onInput){
  const inp=document.createElement('input'); inp.type='color'; inp.value=initVal;
  inp.style.cssText='position:fixed;left:-999px;opacity:0;';
  document.body.appendChild(inp);
  inp.addEventListener('input',e=>onInput(e.target.value));
  inp.addEventListener('change',()=>setTimeout(()=>inp.remove(),300));
  inp.click();
}
function pickColor(){
  if(!selectedEl) return;
  const cur=selectedEl.style.backgroundColor||selectedEl.style.background||'#ffffff';
  openColorPicker(cur.startsWith('#')?cur:rgbToHex(cur), v=>{
    selectedEl.style.backgroundColor=v; selectedEl.style.background=v;
    const dot=document.getElementById('fillDot'),hex=document.getElementById('fillHex');
    if(dot) dot.style.background=v;
    if(hex) hex.textContent=v.slice(1).toUpperCase();
  });
}
function pickTextColor(){
  if(!selectedEl) return;
  openColorPicker(selectedEl.style.color||'#111111', v=>{
    selectedEl.style.color=v;
    const dot=document.getElementById('tcDot'),hex=document.getElementById('tcHex');
    if(dot) dot.style.background=v;
    if(hex) hex.textContent=v.slice(1).toUpperCase();
  });
}

/* -- DRAG (live panel update) -- */
function startDrag(e,el){
  if(tool!=='select') return;
  e.stopPropagation(); e.preventDefault();
  isDragging=true;
  dragStart={x:e.clientX,y:e.clientY};
  dragElStart={x:parseFloat(el.style.left)||0,y:parseFloat(el.style.top)||0};
  const move=ev=>{
    if(!isDragging) return;
    const dx=(ev.clientX-dragStart.x)/zoom, dy=(ev.clientY-dragStart.y)/zoom;
    el.style.left=(dragElStart.x+dx)+'px'; el.style.top=(dragElStart.y+dy)+'px';
    const ix=document.getElementById('inpX'), iy=document.getElementById('inpY');
    if(ix) ix.value=Math.round(dragElStart.x+dx);
    if(iy) iy.value=Math.round(dragElStart.y+dy);
    setHandlesPos(el);
  };
  const up=()=>{ isDragging=false; document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); };
  document.addEventListener('mousemove',move); document.addEventListener('mouseup',up);
}

/* -- CANVAS POINTER -- */
function canvasCoords(e){
  const r=cWrap.getBoundingClientRect();
  return {x:(e.clientX-r.left-panX)/zoom, y:(e.clientY-r.top-panY)/zoom};
}
cWrap.addEventListener('mousedown',e=>{
  if(tool==='hand'||e.button===1){ isPanning=true; panStart={x:e.clientX-panX,y:e.clientY-panY}; cWrap.style.cursor='grabbing'; e.preventDefault(); return; }
  if(tool==='select'){ deselect(); return; }
  if(['rect','ellipse','frame'].includes(tool)){ startDraw(e); return; }
  if(tool==='text'){ createText(e); return; }
});
document.addEventListener('mousemove',e=>{
  if(isPanning){ panX=e.clientX-panStart.x; panY=e.clientY-panStart.y; applyTransform(); }
  if(isDrawing) updateDraw(e);
});
document.addEventListener('mouseup',e=>{
  if(isPanning){ isPanning=false; cWrap.style.cursor='default'; }
  if(isDrawing) finishDraw();
});

/* -- DRAW SHAPES -- */
function startDraw(e){
  const c=canvasCoords(e); drawStart=c; isDrawing=true;
  drawEl=document.createElement('div'); drawEl.className='canvas-elem';
  if(tool==='rect')    drawEl.classList.add('shape-rect');
  if(tool==='ellipse') drawEl.classList.add('shape-ellipse');
  if(tool==='frame'){  drawEl.classList.add('cframe'); const l=document.createElement('div'); l.className='frame-lbl'; l.textContent='Frame'; drawEl.appendChild(l); drawEl.dataset.label='Frame'; }
  else drawEl.dataset.label=tool==='rect'?'Rectangle':'Ellipse';
  drawEl.dataset.kind=tool;
  drawEl.style.cssText=`left:${c.x}px;top:${c.y}px;width:1px;height:1px;`;
  drawEl.addEventListener('mousedown',ev=>{ if(tool==='select') startDrag(ev,drawEl); });
  drawEl.addEventListener('click',ev=>{ ev.stopPropagation(); selectEl(drawEl); });
  world.appendChild(drawEl);
}
function updateDraw(e){
  if(!drawEl) return;
  const c=canvasCoords(e);
  const x=Math.min(c.x,drawStart.x), y=Math.min(c.y,drawStart.y);
  const w=Math.abs(c.x-drawStart.x), h=Math.abs(c.y-drawStart.y);
  drawEl.style.left=x+'px'; drawEl.style.top=y+'px'; drawEl.style.width=w+'px'; drawEl.style.height=h+'px';
}
function finishDraw(){
  isDrawing=false;
  const w=parseInt(drawEl.style.width), h=parseInt(drawEl.style.height);
  if(w<5||h<5){ drawEl.remove(); drawEl=null; return; }
  selectEl(drawEl); buildLayersList(); drawEl=null; setTool('select');
}

/* -- TEXT (natural editing) -- */
let editingText=null;
function stopEditing(){
  if(!editingText) return;
  const el=editingText; editingText=null;
  el.contentEditable='false'; el.dataset.editing='false';
  el.style.cursor='move';
  if(!el.textContent.trim()){ el.remove(); buildLayersList(); deselect(); return; }
  setHandlesPos(el);
}
function createText(e){
  e.preventDefault(); e.stopPropagation();
  const co=canvasCoords(e);
  const el=document.createElement('div');
  el.className='canvas-elem text-elem';
  el.dataset.label='Text'; el.dataset.kind='text'; el.dataset.editing='true';
  el.style.cssText=`position:absolute;left:${co.x}px;top:${co.y}px;font-size:16px;font-family:Inter,sans-serif;color:#111111;min-width:20px;min-height:24px;padding:2px 4px;white-space:pre-wrap;word-break:break-word;cursor:text;outline:none;`;
  el.contentEditable='true';

  el.addEventListener('mousedown',ev=>{
    if(el.dataset.editing==='true'){ ev.stopPropagation(); return; }
    if(tool==='select'){ ev.stopPropagation(); startDrag(ev,el); }
  });
  el.addEventListener('click',ev=>{ ev.stopPropagation(); selectEl(el); });
  el.addEventListener('dblclick',ev=>{
    ev.stopPropagation();
    el.contentEditable='true'; el.dataset.editing='true'; editingText=el;
    el.style.cursor='text'; el.focus();
  });
  el.addEventListener('keydown',ev=>{
    ev.stopPropagation();
    if(ev.key==='Escape'){ ev.preventDefault(); stopEditing(); setTool('select'); }
    if(ev.key==='Enter'&&!ev.shiftKey){ ev.preventDefault(); stopEditing(); setTool('select'); }
  });
  el.addEventListener('blur',()=>{
    if(el.dataset.editing==='true') setTimeout(()=>{ if(el.dataset.editing==='true') stopEditing(); },150);
  });

  world.appendChild(el);
  editingText=el;
  // Use setTimeout so the mouseup doesn't steal focus
  setTimeout(()=>{ el.focus(); }, 20);
  selectEl(el); buildLayersList();
}

/* -- TOOL -- */
function setTool(t){
  tool=t;
  document.querySelectorAll('.bt[data-tool]').forEach(b=>b.classList.toggle('on',b.dataset.tool===t));
  cWrap.style.cursor=t==='hand'?'grab':['rect','ellipse','frame'].includes(t)?'crosshair':t==='text'?'text':'default';
}
document.querySelectorAll('.bt[data-tool]').forEach(b=>b.addEventListener('click',()=>setTool(b.dataset.tool)));

/* -- PANEL TOGGLE -- */
let panelOpen=true;
function togglePanel(){
  panelOpen=!panelOpen;
  document.getElementById('lpanel').style.display=panelOpen?'':'none';
  document.getElementById('ibLayers').classList.toggle('on',panelOpen);
  document.querySelector('.shell').style.gridTemplateColumns=panelOpen
    ?'var(--icon) var(--lpanel) 1fr var(--rpanel)':'var(--icon) 0 1fr var(--rpanel)';
}

/* -- KEYBOARD -- */
document.addEventListener('keydown',e=>{
  if(e.target.isContentEditable||e.target.tagName==='INPUT'||e.target.tagName==='SELECT') return;
  const map={v:'select',f:'frame',r:'rect',o:'ellipse',t:'text',h:'hand'};
  if(map[e.key]){ setTool(map[e.key]); return; }
  if((e.key==='Delete'||e.key==='Backspace')&&selectedEl&&!selectedEl.classList.contains('cframe')
      &&selectedEl.dataset.editing!=='true'){
    selectedEl.remove(); deselect(); buildLayersList();
  }
  if((e.ctrlKey||e.metaKey)&&e.key==='+'){ e.preventDefault(); changeZoom(0.1); }
  if((e.ctrlKey||e.metaKey)&&e.key==='-'){ e.preventDefault(); changeZoom(-0.1); }
  if((e.ctrlKey||e.metaKey)&&e.key==='0'){ e.preventDefault(); zoom=1; panX=60; panY=60; applyTransform(); }
  if(e.key==='Escape'){ stopEditing&&stopEditing(); setTool('select'); }
});


/* -- LAYERING -- */
function layerMoveUp(el){
  if(!el) return;
  const next=el.nextElementSibling;
  if(next && next.id!=='hov') world.insertBefore(next,el);
  buildLayersList();
}
function layerMoveDown(el){
  if(!el) return;
  const prev=el.previousElementSibling;
  if(prev) world.insertBefore(el,prev);
  buildLayersList();
}
function layerToFront(el){
  if(!el) return;
  const hov=document.getElementById('hov');
  world.insertBefore(el,hov); buildLayersList();
}
function layerToBack(el){
  if(!el) return;
  world.insertBefore(el,world.firstChild); buildLayersList();
}
applyTransform();
</script>
</body>
</html>




